// FRY Word List Management System
// Organized by levels with comprehensive sight word data

export const FRY_WORD_LEVELS = {
  level1: {
    name: 'Level 1 (Pre-K to Grade 1)',
    description: 'Most basic sight words - 100 most frequent words',
    words: [
      // First 25 words
      'the',
      'of',
      'and',
      'a',
      'to',
      'in',
      'is',
      'you',
      'that',
      'it',
      'he',
      'was',
      'for',
      'on',
      'are',
      'as',
      'with',
      'his',
      'they',
      'i',
      'at',
      'be',
      'this',
      'have',
      'from',

      // Second 25 words
      'or',
      'one',
      'had',
      'by',
      'word',
      'but',
      'not',
      'what',
      'all',
      'were',
      'we',
      'when',
      'your',
      'can',
      'said',
      'there',
      'each',
      'which',
      'she',
      'do',
      'how',
      'their',
      'if',
      'will',
      'up',

      // Third 25 words
      'other',
      'about',
      'out',
      'many',
      'then',
      'them',
      'these',
      'so',
      'some',
      'her',
      'would',
      'make',
      'like',
      'into',
      'him',
      'has',
      'two',
      'more',
      'very',
      'what',
      'know',
      'just',
      'first',
      'get',
      'over',

      // Fourth 25 words
      'think',
      'also',
      'its',
      'back',
      'after',
      'use',
      'two',
      'our',
      'work',
      'first',
      'well',
      'way',
      'even',
      'new',
      'want',
      'because',
      'any',
      'these',
      'give',
      'day',
      'most',
      'us'
    ],
    difficulty: 1,
    targetAge: '4-6 years',
    averageLength: 3.2
  },

  level2: {
    name: 'Level 2 (Grades 1-2)',
    description: 'Essential sight words for early reading fluency',
    words: [
      'through',
      'much',
      'before',
      'line',
      'right',
      'too',
      'means',
      'old',
      'any',
      'same',
      'tell',
      'boy',
      'follow',
      'came',
      'want',
      'show',
      'also',
      'around',
      'farm',
      'three',
      'small',
      'set',
      'put',
      'end',
      'why',
      'again',
      'turn',
      'here',
      'off',
      'went',
      'old',
      'number',
      'great',
      'tell',
      'men',
      'say',
      'small',
      'every',
      'found',
      'still',
      'between',
      'name',
      'should',
      'home',
      'big',
      'give',
      'air',
      'line',
      'set',
      'own',
      'under',
      'read',
      'last',
      'never',
      'us',
      'left',
      'end',
      'along',
      'while',
      'might',
      'next',
      'sound',
      'below',
      'saw',
      'something',
      'thought',
      'both',
      'few',
      'those',
      'always',
      'looked',
      'show',
      'large',
      'often',
      'together',
      'asked',
      'house',
      "don't",
      'world',
      'going',
      'want',
      'school',
      'important',
      'until',
      'form',
      'food',
      'keep',
      'children',
      'feet',
      'land',
      'side',
      'without',
      'boy',
      'once',
      'animal',
      'life',
      'enough',
      'took',
      'sometimes',
      'four',
      'head',
      'above',
      'kind',
      'began',
      'almost',
      'live'
    ],
    difficulty: 2,
    targetAge: '6-8 years',
    averageLength: 4.1
  },

  level3: {
    name: 'Level 3 (Grades 2-3)',
    description: 'Intermediate sight words for developing readers',
    words: [
      'example',
      'begin',
      'life',
      'always',
      'those',
      'both',
      'paper',
      'together',
      'got',
      'group',
      'often',
      'run',
      'important',
      'until',
      'children',
      'side',
      'feet',
      'car',
      'mile',
      'night',
      'walk',
      'white',
      'sea',
      'began',
      'grow',
      'took',
      'river',
      'four',
      'carry',
      'state',
      'once',
      'book',
      'hear',
      'stop',
      'without',
      'second',
      'later',
      'miss',
      'idea',
      'enough',
      'eat',
      'face',
      'watch',
      'far',
      'indian',
      'really',
      'almost',
      'let',
      'above',
      'girl',
      'sometimes',
      'mountain',
      'cut',
      'young',
      'talk',
      'soon',
      'list',
      'song',
      'being',
      'leave',
      'family',
      "it's",
      'body',
      'music',
      'color',
      'stand',
      'sun',
      'questions',
      'fish',
      'area',
      'mark',
      'dog',
      'horse',
      'birds',
      'problem',
      'complete',
      'room',
      'knew',
      'since',
      'ever',
      'piece',
      'told',
      'usually',
      "didn't",
      'friends',
      'easy',
      'heard',
      'order',
      'red',
      'door',
      'sure',
      'become',
      'top',
      'ship',
      'across',
      'today',
      'during',
      'short',
      'better',
      'best',
      'however',
      'low',
      'hours',
      'black',
      'products',
      'happened',
      'whole',
      'measure',
      'remember',
      'early',
      'waves',
      'reached'
    ],
    difficulty: 3,
    targetAge: '7-9 years',
    averageLength: 4.8
  },

  level4: {
    name: 'Level 4 (Grades 3-4)',
    description: 'Advanced sight words for fluent readers',
    words: [
      'listen',
      'wind',
      'rock',
      'space',
      'covered',
      'fast',
      'several',
      'hold',
      'himself',
      'toward',
      'five',
      'step',
      'morning',
      'passed',
      'vowel',
      'true',
      'hundred',
      'against',
      'pattern',
      'numeral',
      'table',
      'north',
      'slowly',
      'money',
      'map',
      'farm',
      'pulled',
      'draw',
      'voice',
      'seen',
      'cold',
      'cried',
      'plan',
      'notice',
      'south',
      'sing',
      'war',
      'ground',
      'fall',
      'king',
      'town',
      "I'll",
      'unit',
      'figure',
      'certain',
      'field',
      'travel',
      'wood',
      'fire',
      'upon',
      'done',
      'English',
      'road',
      'half',
      'ten',
      'fly',
      'gave',
      'box',
      'finally',
      'wait',
      'correct',
      'oh',
      'quickly',
      'person',
      'became',
      'shown',
      'minutes',
      'strong',
      'verb',
      'stars',
      'front',
      'feel',
      'fact',
      'inches',
      'street',
      'decided',
      'contain',
      'course',
      'surface',
      'produce',
      'building',
      'ocean',
      'class',
      'note',
      'nothing',
      'rest',
      'carefully',
      'scientists',
      'inside',
      'wheels',
      'stay',
      'green',
      'known',
      'island',
      'week',
      'less',
      'machine',
      'base',
      'ago',
      'stood',
      'plane',
      'system',
      'behind',
      'ran',
      'round',
      'boat',
      'game',
      'force',
      'brought',
      'heat',
      'nothing',
      'quite',
      'broke',
      'case',
      'middle',
      'kill',
      'son',
      'lake',
      'moment',
      'scale',
      'loud',
      'spring',
      'observe',
      'child',
      'straight',
      'consonant',
      'nation',
      'dictionary',
      'milk',
      'speed',
      'method',
      'organ',
      'pay',
      'age',
      'section',
      'dress',
      'cloud',
      'surprise',
      'quiet',
      'stone',
      'tiny',
      'climb',
      'bad',
      'oil',
      'blood',
      'touch',
      'grew',
      'cent',
      'mix',
      'team',
      'wire',
      'cost',
      'lost',
      'brown',
      'wear',
      'garden',
      'equal',
      'sent',
      'choose',
      'fell',
      'fit',
      'flow',
      'fair',
      'bank',
      'collect',
      'save',
      'control',
      'decimal',
      'ear',
      'else',
      'quite',
      'broke',
      'case',
      'middle',
      'kill',
      'son',
      'lake'
    ],
    difficulty: 4,
    targetAge: '8-10 years',
    averageLength: 5.3
  },

  level5: {
    name: 'Level 5 (Grades 4-5)',
    description: 'Complex sight words for advanced readers',
    words: [
      'general',
      'energy',
      'subject',
      'Europe',
      'moon',
      'region',
      'return',
      'believe',
      'dance',
      'members',
      'picked',
      'simple',
      'cells',
      'paint',
      'mind',
      'love',
      'cause',
      'rain',
      'exercise',
      'eggs',
      'train',
      'blue',
      'wish',
      'drop',
      'developed',
      'window',
      'difference',
      'distance',
      'heart',
      'site',
      'sum',
      'summer',
      'wall',
      'forest',
      'probably',
      'legs',
      'sat',
      'main',
      'winter',
      'wide',
      'written',
      'length',
      'reason',
      'kept',
      'interest',
      'arms',
      'brother',
      'race',
      'present',
      'beautiful',
      'store',
      'job',
      'edge',
      'past',
      'sign',
      'record',
      'finished',
      'discovered',
      'wild',
      'happy',
      'beside',
      'gone',
      'sky',
      'grass',
      'million',
      'west',
      'lay',
      'weather',
      'root',
      'instruments',
      'meet',
      'third',
      'months',
      'paragraph',
      'raised',
      'represent',
      'soft',
      'whether',
      'clothes',
      'flowers',
      'shall',
      'teacher',
      'held',
      'describe',
      'drive',
      'cross',
      'speak',
      'solve',
      'appear',
      'metal',
      'son',
      'either',
      'ice',
      'sleep',
      'village',
      'factors',
      'result',
      'jumped',
      'snow',
      'ride',
      'care',
      'floor',
      'hill',
      'pushed',
      'baby',
      'buy',
      'century',
      'outside',
      'everything',
      'tall',
      'already',
      'instead',
      'phrase',
      'soil',
      'bed',
      'copy',
      'free',
      'hope',
      'spring',
      'case',
      'laughed',
      'nation',
      'quite',
      'type',
      'themselves',
      'temperature',
      'bright',
      'lead',
      'everyone',
      'method',
      'section',
      'lake',
      'iron',
      'within',
      'dictionary',
      'hair',
      'age',
      'amount',
      'scale',
      'pounds',
      'although',
      'per',
      'broken',
      'moment',
      'tiny',
      'possible',
      'gold',
      'milk',
      'quiet',
      'natural',
      'lot',
      'stone',
      'act',
      'build',
      'middle',
      'speed',
      'count',
      'cat',
      'someone',
      'sail',
      'rolled',
      'bear',
      'wonder',
      'smiled',
      'angle',
      'fraction',
      'Africa',
      'killed',
      'melody',
      'bottom',
      'trip',
      'hole',
      'poor',
      "let's",
      'fight',
      'surprise',
      'French',
      'died',
      'beat',
      'exactly',
      'remain',
      'dress',
      'iron',
      "couldn't",
      'fingers',
      'row',
      'least',
      'catch',
      'climbed',
      'wrote',
      'shouted',
      'continued',
      'itself',
      'else',
      'plains',
      'gas',
      'England',
      'burning',
      'design',
      'joined'
    ],
    difficulty: 5,
    targetAge: '9-11 years',
    averageLength: 6.1
  }
}

// Word difficulty assessment based on various factors
export const assessWordDifficulty = (word) => {
  const factors = {
    length: word.length,
    vowelCount: (word.match(/[aeiou]/gi) || []).length,
    consonantClusters: (word.match(/[bcdfghjklmnpqrstvwxyz]{2,}/gi) || [])
      .length,
    syllables: estimateSyllables(word),
    irregularPhonics: isIrregularPhonic(word)
  }

  let difficultyScore = 0

  // Length factor
  if (factors.length <= 3) difficultyScore += 1
  else if (factors.length <= 5) difficultyScore += 2
  else if (factors.length <= 7) difficultyScore += 3
  else difficultyScore += 4

  // Syllable factor
  difficultyScore += factors.syllables

  // Consonant cluster factor
  difficultyScore += factors.consonantClusters * 0.5

  // Irregular phonics factor
  if (factors.irregularPhonics) difficultyScore += 2

  return Math.min(5, Math.max(1, Math.round(difficultyScore / 2)))
}

// Estimate syllables in a word
const estimateSyllables = (word) => {
  const vowelMatches = word.toLowerCase().match(/[aeiouy]+/g)
  let syllableCount = vowelMatches ? vowelMatches.length : 1

  // Adjust for silent e
  if (word.toLowerCase().endsWith('e') && syllableCount > 1) {
    syllableCount--
  }

  return Math.max(1, syllableCount)
}

// Check if word has irregular phonics
const isIrregularPhonic = (word) => {
  const irregularWords = [
    'the',
    'of',
    'was',
    'one',
    'two',
    'said',
    'have',
    'what',
    'were',
    'you',
    'your',
    'said',
    'come',
    'some',
    'would',
    'could',
    'should',
    'though',
    'through',
    'enough',
    'laugh',
    'cough',
    'rough',
    'tough'
  ]

  return irregularWords.includes(word.toLowerCase())
}

// Get words by level
export const getWordsByLevel = (level) => {
  return FRY_WORD_LEVELS[`level${level}`]?.words || []
}

// Get all words up to a certain level
export const getWordsUpToLevel = (maxLevel) => {
  let allWords = []
  for (let i = 1; i <= maxLevel; i++) {
    allWords = allWords.concat(getWordsByLevel(i))
  }
  return allWords
}

// Determine appropriate level for a student based on their performance
export const determineStudentLevel = (assessmentHistory) => {
  if (!assessmentHistory || assessmentHistory.length === 0) {
    return { recommendedLevel: 1, confidence: 'low' }
  }

  // Calculate accuracy by level
  const levelAccuracy = {}

  assessmentHistory.forEach((assessment) => {
    const word = assessment.wordTested
    const level = getWordLevel(word)

    if (level) {
      if (!levelAccuracy[level]) {
        levelAccuracy[level] = { correct: 0, total: 0 }
      }

      const correct =
        assessment.responses?.filter((r) => r.isCorrect).length || 0
      const total = assessment.responses?.length || 1

      levelAccuracy[level].correct += correct
      levelAccuracy[level].total += total
    }
  })

  // Find the highest level with at least 80% accuracy
  let recommendedLevel = 1
  let confidence = 'high'

  for (let level = 1; level <= 5; level++) {
    if (levelAccuracy[level]) {
      const accuracy = levelAccuracy[level].correct / levelAccuracy[level].total
      if (accuracy >= 0.8 && levelAccuracy[level].total >= 5) {
        recommendedLevel = Math.min(5, level + 1)
      } else if (accuracy < 0.6) {
        confidence = 'medium'
        break
      }
    }
  }

  // Adjust confidence based on data availability
  const totalAssessments = assessmentHistory.length
  if (totalAssessments < 10) confidence = 'low'
  else if (totalAssessments < 20) confidence = 'medium'

  return { recommendedLevel, confidence }
}

// Get the level that a specific word belongs to
export const getWordLevel = (word) => {
  for (let level = 1; level <= 5; level++) {
    if (getWordsByLevel(level).includes(word.toLowerCase())) {
      return level
    }
  }
  return null
}

// Generate a balanced word set for testing
export const generateTestWordSet = (level, count = 10, options = {}) => {
  const {
    includeReview = true,
    reviewPercentage = 0.3,
    difficultyVariation = true
  } = options

  let availableWords = []

  // Add words from current level
  availableWords = availableWords.concat(getWordsByLevel(level))

  // Add review words from previous levels
  if (includeReview && level > 1) {
    const reviewCount = Math.floor(count * reviewPercentage)
    const reviewWords = getWordsUpToLevel(level - 1)
    availableWords = availableWords.concat(
      shuffleArray(reviewWords).slice(0, reviewCount)
    )
  }

  // Shuffle and select words
  const selectedWords = shuffleArray(availableWords).slice(0, count)

  // Add difficulty variation if requested
  if (difficultyVariation && level < 5) {
    const challengeCount = Math.floor(count * 0.1)
    const challengeWords = getWordsByLevel(level + 1)
    if (challengeWords.length > 0) {
      selectedWords.splice(
        -challengeCount,
        challengeCount,
        ...shuffleArray(challengeWords).slice(0, challengeCount)
      )
    }
  }

  return selectedWords
}

// Utility function to shuffle array
const shuffleArray = (array) => {
  const shuffled = [...array]
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
  }
  return shuffled
}

// Get practice recommendations based on student performance
export const getPracticeRecommendations = (studentProgress) => {
  const recommendations = []

  if (!studentProgress || !studentProgress.assessments) {
    return [
      {
        type: 'start',
        priority: 'high',
        message: 'Begin with Level 1 basic sight words',
        action: 'Start assessment to determine reading level'
      }
    ]
  }

  const recentAssessments = studentProgress.assessments.filter(
    (a) =>
      new Date(a.dateCompleted) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
  )

  if (recentAssessments.length === 0) {
    recommendations.push({
      type: 'assessment',
      priority: 'medium',
      message: 'No recent assessments found',
      action: 'Schedule a new assessment to track progress'
    })
  }

  // Analyze accuracy trends
  const overallAccuracy = calculateOverallAccuracy(recentAssessments)

  if (overallAccuracy < 0.6) {
    recommendations.push({
      type: 'review',
      priority: 'high',
      message: 'Accuracy below 60% - needs additional practice',
      action: 'Focus on reviewing previously learned words'
    })
  } else if (overallAccuracy > 0.9) {
    recommendations.push({
      type: 'advance',
      priority: 'medium',
      message: 'High accuracy achieved - ready for next level',
      action: 'Introduce words from the next difficulty level'
    })
  }

  // Check for specific test type weaknesses
  const testTypePerformance = analyzeTestTypePerformance(recentAssessments)

  Object.entries(testTypePerformance).forEach(([testType, accuracy]) => {
    if (accuracy < 0.7) {
      recommendations.push({
        type: 'skill',
        priority: 'medium',
        message: `${testType} skills need improvement (${(
          accuracy * 100
        ).toFixed(1)}% accuracy)`,
        action: `Focus on ${testType} practice exercises`
      })
    }
  })

  return recommendations
}

// Helper function to calculate overall accuracy
const calculateOverallAccuracy = (assessments) => {
  if (!assessments.length) return 0

  const totalResponses = assessments.reduce(
    (sum, assessment) => sum + (assessment.responses?.length || 0),
    0
  )
  const correctResponses = assessments.reduce(
    (sum, assessment) =>
      sum + (assessment.responses?.filter((r) => r.isCorrect).length || 0),
    0
  )

  return totalResponses > 0 ? correctResponses / totalResponses : 0
}

// Helper function to analyze performance by test type
const analyzeTestTypePerformance = (assessments) => {
  const testTypes = ['recognition', 'pronunciation', 'spelling', 'reading']
  const performance = {}

  testTypes.forEach((testType) => {
    const typeAssessments = assessments.filter((a) => a.testType === testType)
    performance[testType] = calculateOverallAccuracy(typeAssessments)
  })

  return performance
}

export default {
  FRY_WORD_LEVELS,
  assessWordDifficulty,
  getWordsByLevel,
  getWordsUpToLevel,
  determineStudentLevel,
  getWordLevel,
  generateTestWordSet,
  getPracticeRecommendations
}
